<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Proof of Event (PoE) - Plataforma</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        .fade-in { animation: fadeIn 0.3s ease-in; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .card { border: 1px solid #e5e7eb; border-radius: 12px; transition: all 0.2s ease; }
        .card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); transform: translateY(-2px); }
        .btn-primary { background: linear-gradient(90deg, #3b82f6, #8b5cf6); color: white; padding: 10px 24px; border-radius: 8px; font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
        .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3); }
        .btn-secondary { background: white; color: #374151; padding: 10px 24px; border-radius: 8px; font-weight: 600; border: 1px solid #d1d5db; cursor: pointer; transition: all 0.2s; }
        .btn-secondary:hover { background: #f9fafb; border-color: #9ca3af; }
        .nav-tab { padding: 12px 20px; border-radius: 8px; cursor: pointer; transition: all 0.2s; font-weight: 500; }
        .nav-tab.active { background-color: #eff6ff; color: #3b82f6; }
        .nav-tab:hover:not(.active) { background-color: #f9fafb; }
        .input-field { border: 1px solid #d1d5db; border-radius: 8px; padding: 12px 16px; width: 100%; transition: all 0.2s; }
        .input-field:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .logo { font-weight: 700; font-size: 1.5rem; background: linear-gradient(90deg, #3b82f6, #8b5cf6); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">
    <!-- SIMPLIFIQUEI MUITO PARA TESTE - Vamos fazer funcionar primeiro -->
    <div class="min-h-screen">
        <!-- Header -->
        <header class="bg-white shadow-sm border-b">
            <div class="container mx-auto px-4 py-4">
                <div class="flex justify-between items-center">
                    <div class="flex items-center space-x-3">
                        <div class="logo">Proof of Event</div>
                        <span class="text-sm text-gray-500">v0.1</span>
                    </div>
                    <div class="flex items-center space-x-4">
                        <div class="text-right">
                            <div class="font-medium" id="company-name">PoE Protocol</div>
                            <div class="text-sm text-gray-500" id="company-email">Ledger local determinístico</div>
                        </div>
                        <div id="user-avatar" class="w-10 h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-full flex items-center justify-center text-white font-bold">
                            P
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Main Container -->
        <div class="container mx-auto px-4 py-8">
            <div class="grid grid-cols-1 lg:grid-cols-4 gap-8">
                <!-- Sidebar -->
                <div class="lg:col-span-1">
                    <div class="card bg-white p-6 mb-6">
                        <h3 class="font-bold text-lg mb-4">Navegação</h3>
                        <div class="space-y-2">
                            <div class="nav-tab active" onclick="showTab('dashboard')">
                                <i class="fas fa-chart-bar mr-3"></i> Dashboard
                            </div>
                            <div class="nav-tab" onclick="showTab('register')">
                                <i class="fas fa-plus-circle mr-3"></i> Registrar Evento
                            </div>
                            <div class="nav-tab" onclick="showTab('deposit')">
                                <i class="fas fa-hand-holding-usd mr-3"></i> Depósito
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Main Content -->
                <div class="lg:col-span-3">
                    <!-- Dashboard Tab -->
                    <div id="dashboard-tab" class="tab-content fade-in">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Dashboard PoE v0.1</h1>
                            <p class="text-gray-600">Registro determinístico local</p>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                            <div class="card bg-white p-6">
                                <p class="text-gray-500 text-sm">Créditos Disponíveis</p>
                                <p class="text-3xl font-bold mt-2" id="credits-count">0</p>
                            </div>
                            
                            <div class="card bg-white p-6">
                                <p class="text-gray-500 text-sm">Eventos Registrados</p>
                                <p class="text-3xl font-bold mt-2" id="events-count">0</p>
                            </div>
                        </div>
                        
                        <div class="card bg-white p-6">
                            <h2 class="text-xl font-bold mb-4">Status</h2>
                            <p class="text-gray-600">Sistema funcionando corretamente</p>
                            <button onclick="testLedger()" class="btn-primary mt-4">Testar Ledger</button>
                        </div>
                    </div>
                    
                    <!-- Register Event Tab -->
                    <div id="register-tab" class="tab-content fade-in" style="display: none;">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Registrar Evento</h1>
                        </div>
                        
                        <div class="card bg-white p-6">
                            <input type="text" id="event-hash" class="input-field mb-4" placeholder="Hash SHA-512">
                            <textarea id="event-metadata" class="input-field h-32 mb-4" placeholder='Metadados JSON'></textarea>
                            <button onclick="registerEvent()" class="btn-primary">Registrar Evento</button>
                        </div>
                    </div>
                    
                    <!-- Deposit Tab -->
                    <div id="deposit-tab" class="tab-content fade-in" style="display: none;">
                        <div class="mb-8">
                            <h1 class="text-3xl font-bold text-gray-900">Registrar Depósito</h1>
                        </div>
                        
                        <div class="card bg-white p-6">
                            <input type="text" id="deposit-hash" class="input-field mb-4" placeholder="Hash do comprovante">
                            <input type="number" id="deposit-amount" class="input-field mb-4" placeholder="Quantidade">
                            <textarea id="deposit-metadata" class="input-field h-32 mb-4" placeholder='Metadados'></textarea>
                            <button onclick="registerDeposit()" class="btn-primary">Registrar Depósito</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript SIMPLIFICADO - Vamos fazer funcionar primeiro -->
    <script>
        console.log("DEBUG: Script carregando...");
        
        // ==============================================
        // LEDGER BÁSICO
        // ==============================================
        const LEDGER_KEY = 'poe_ledger_v1';
        let ledger = [];
        
        // Carregar ledger
        function loadLedger() {
            try {
                console.log("DEBUG: Carregando ledger...");
                const saved = localStorage.getItem(LEDGER_KEY);
                ledger = saved ? JSON.parse(saved) : [];
                console.log("DEBUG: Ledger carregado com", ledger.length, "registros");
            } catch (e) {
                console.error("DEBUG: Erro ao carregar ledger:", e);
                ledger = [];
            }
        }
        
        // Salvar ledger
        function saveLedger() {
            try {
                localStorage.setItem(LEDGER_KEY, JSON.stringify(ledger));
                console.log("DEBUG: Ledger salvo");
            } catch (e) {
                console.error("DEBUG: Erro ao salvar ledger:", e);
            }
        }
        
        // ==============================================
        // FUNÇÕES BÁSICAS
        // ==============================================
        
        // Gerar hash simples
        async function generateSHA512Hash(input) {
            // Simplificado para testes
            const encoder = new TextEncoder();
            const data = encoder.encode(input);
            const hashArray = Array.from(data)
                .map(byte => byte.toString(16).padStart(2, '0'))
                .slice(0, 10);
            return hashArray.join('').padEnd(128, '0').slice(0, 128);
        }
        
        // Calcular créditos
        function calculateAvailableCredits() {
            const deposits = ledger.filter(item => item.type === 'deposit')
                                 .reduce((sum, item) => sum + (item.amount || 0), 0);
            const events = ledger.filter(item => item.type === 'event').length;
            return Math.max(0, deposits - events);
        }
        
        // Calcular eventos
        function calculateTotalEvents() {
            return ledger.filter(item => item.type === 'event').length;
        }
        
        // ==============================================
        // UI FUNCTIONS
        // ==============================================
        
        // Mostrar tab
        function showTab(tabName) {
            console.log("DEBUG: Mostrando tab", tabName);
            
            // Esconde todas as tabs
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.style.display = 'none';
            });
            
            // Remove classe active
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Mostra tab selecionada
            const tabElement = document.getElementById(`${tabName}-tab`);
            if (tabElement) {
                tabElement.style.display = 'block';
            } else {
                console.error("DEBUG: Tab não encontrada:", tabName);
            }
            
            // Ativa navegação
            document.querySelectorAll('.nav-tab').forEach(tab => {
                if (tab.textContent.includes(tabName.charAt(0).toUpperCase() + tabName.slice(1))) {
                    tab.classList.add('active');
                }
            });
            
            updateDashboard();
        }
        
        // Atualizar dashboard
        function updateDashboard() {
            console.log("DEBUG: Atualizando dashboard...");
            const credits = calculateAvailableCredits();
            const events = calculateTotalEvents();
            
            const creditsElement = document.getElementById('credits-count');
            const eventsElement = document.getElementById('events-count');
            
            if (creditsElement) creditsElement.textContent = credits;
            if (eventsElement) eventsElement.textContent = events;
            
            console.log("DEBUG: Dashboard atualizado - créditos:", credits, "eventos:", events);
        }
        
        // Registrar evento
        async function registerEvent() {
            console.log("DEBUG: Registrando evento...");
            const hashInput = document.getElementById('event-hash');
            const hash = hashInput.value.trim();
            
            if (!hash) {
                alert("Digite um hash");
                return;
            }
            
            const availableCredits = calculateAvailableCredits();
            if (availableCredits <= 0) {
                alert("Créditos insuficientes");
                return;
            }
            
            try {
                const timestamp = new Date().toISOString();
                const proofInput = hash + timestamp;
                const poeProof = await generateSHA512Hash(proofInput);
                
                const eventRecord = {
                    type: 'event',
                    id: `event_${Date.now()}`,
                    hash: hash,
                    timestamp: timestamp,
                    poeProof: poeProof,
                    createdAt: new Date().toISOString()
                };
                
                ledger.push(eventRecord);
                saveLedger();
                updateDashboard();
                
                hashInput.value = '';
                alert("Evento registrado!");
                console.log("DEBUG: Evento registrado com sucesso");
                
            } catch (error) {
                console.error("DEBUG: Erro ao registrar evento:", error);
                alert("Erro: " + error.message);
            }
        }
        
        // Registrar depósito
        async function registerDeposit() {
            console.log("DEBUG: Registrando depósito...");
            const hashInput = document.getElementById('deposit-hash');
            const amountInput = document.getElementById('deposit-amount');
            
            const hash = hashInput.value.trim();
            const amount = parseInt(amountInput.value);
            
            if (!hash || !amount || amount < 1) {
                alert("Preencha todos os campos corretamente");
                return;
            }
            
            try {
                const timestamp = new Date().toISOString();
                const proofInput = hash + timestamp + amount;
                const poeProof = await generateSHA512Hash(proofInput);
                
                const depositRecord = {
                    type: 'deposit',
                    id: `deposit_${Date.now()}`,
                    hash: hash,
                    amount: amount,
                    timestamp: timestamp,
                    poeProof: poeProof,
                    createdAt: new Date().toISOString()
                };
                
                ledger.push(depositRecord);
                saveLedger();
                updateDashboard();
                
                hashInput.value = '';
                amountInput.value = '';
                alert(`Depósito de ${amount} créditos registrado!`);
                console.log("DEBUG: Depósito registrado com sucesso");
                
            } catch (error) {
                console.error("DEBUG: Erro ao registrar depósito:", error);
                alert("Erro: " + error.message);
            }
        }
        
        // Testar ledger
        function testLedger() {
            console.log("DEBUG: Testando ledger...");
            console.log("Ledger atual:", ledger);
            console.log("LocalStorage:", localStorage.getItem(LEDGER_KEY));
            console.log("Créditos:", calculateAvailableCredits());
            console.log("Eventos:", calculateTotalEvents());
            alert("Verifique o console (F12)");
        }
        
        // ==============================================
        // INICIALIZAÇÃO
        // ==============================================
        document.addEventListener('DOMContentLoaded', function() {
            console.log("DEBUG: DOM carregado, inicializando...");
            
            try {
                // Carregar dados
                loadLedger();
                
                // Atualizar UI
                updateDashboard();
                
                // Mostrar dashboard inicial
                showTab('dashboard');
                
                console.log("DEBUG: Sistema inicializado com sucesso!");
                console.log("Ledger inicial:", ledger);
                
            } catch (error) {
                console.error("DEBUG: Erro na inicialização:", error);
                alert("Erro ao inicializar: " + error.message);
            }
        });
    </script>
</body>
</html>
